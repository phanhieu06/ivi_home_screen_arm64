name: Build ARM64 Binary

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install cross-compiler, tools, and headers (AMD64)
        run: |
          # 1. CÃ i Ä‘áº·t cÃ¡c cÃ´ng cá»¥ chÃ©o vÃ  headers AMD64 (APT chá»‰ dÃ¹ng cho x86_64/AMD64)
          sudo apt-get update -o Acquire::Retries=3 || true 
          sudo apt-get install -y --no-install-recommends \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libwayland-dev libegl1-mesa-dev libgles2-mesa-dev \
            wget dpkg-dev binutils

      - name: Manually Install Core ARM64 Runtime Libraries (Dynamic URL Search - Final Path Fix) ðŸ‘ˆ FIX
        run: |
          # Thiáº¿t láº­p thÆ° má»¥c cho thÆ° viá»‡n chÃ©o
          CORE_LIB_DIR=/usr/aarch64-linux-gnu/lib
          mkdir -p ${CORE_LIB_DIR}
          
          # --- 1. Táº£i vÃ  trÃ­ch xuáº¥t libc6 (glibc) sá»­ dá»¥ng tÃ¬m kiáº¿m Ä‘á»™ng ---
          echo "Searching for the latest libc6:arm64 version..."
          
          # FIX: Sá»­ dá»¥ng chuá»—i lá»‡nh grep/cut Ä‘á»ƒ trÃ­ch xuáº¥t TÃŠN FILE CHÃNH XÃC tá»« thuá»™c tÃ­nh href, loáº¡i bá» HTML thá»«a.
          GLIBC_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/ 2>/dev/null | grep 'libc6_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          GLIBC_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/${GLIBC_FILENAME}"
          
          echo "Found libc6:arm64 at URL: ${GLIBC_URL}. Starting download..."
          wget "${GLIBC_URL}" -O libc6.deb
          
          # KIá»‚M TRA Lá»–I: Náº¿u táº£i xuá»‘ng tháº¥t báº¡i, dá»«ng láº¡i ngay
          if [ ! -f libc6.deb ]; then
             echo "ERROR: Failed to download libc6 ARM64 version. Filename extracted: ${GLIBC_FILENAME}"
             exit 1
          fi
          
          dpkg-deb -x libc6.deb /tmp/glibc_extract
          # ÄÃƒ Sá»¬A: Thay tháº¿ /lib báº±ng /usr/lib Ä‘á»ƒ phÃ¹ há»£p vá»›i cáº¥u trÃºc gÃ³i Ubuntu hiá»‡n Ä‘áº¡i
          cp /tmp/glibc_extract/usr/lib/aarch64-linux-gnu/libc.so.6 ${CORE_LIB_DIR}/
          cp /tmp/glibc_extract/usr/lib/aarch64-linux-gnu/libm.so.6 ${CORE_LIB_DIR}/
          
          # --- 2. Táº£i vÃ  trÃ­ch xuáº¥t libstdc++6 sá»­ dá»¥ng tÃ¬m kiáº¿m Ä‘á»™ng ---
          echo "Searching for the latest libstdc++6:arm64 version..."
          
          # FIX: Sá»­ dá»¥ng chuá»—i lá»‡nh grep/cut Ä‘á»ƒ trÃ­ch xuáº¥t TÃŠN FILE CHÃNH XÃC tá»« thuá»™c tÃ­nh href.
          LIBSTDC_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/g/gcc-12/ 2>/dev/null | grep 'libstdc++6_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          LIBSTDC_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/g/gcc-12/${LIBSTDC_FILENAME}"

          echo "Found libstdc++6:arm64 at URL: ${LIBSTDC_URL}. Starting download..."
          wget "${LIBSTDC_URL}" -O libstdc++.deb

          # KIá»‚M TRA Lá»–I: Náº¿u táº£i xuá»‘ng tháº¥t báº¡i, dá»«ng láº¡i ngay
          if [ ! -f libstdc++.deb ]; then
             echo "ERROR: Failed to download libstdc++6 ARM64 version. Filename extracted: ${LIBSTDC_FILENAME}"
             exit 1
          fi

          dpkg-deb -x libstdc++.deb /tmp/libstdc_extract
          cp /tmp/libstdc_extract/usr/lib/aarch64-linux-gnu/libstdc++.so.6 ${CORE_LIB_DIR}/
          
          # Äáº·t biáº¿n mÃ´i trÆ°á»ng cho bÆ°á»›c build
          echo "CROSS_LIB_PATH=${CORE_LIB_DIR}" >> $GITHUB_ENV
          
      - name: Create ARM64 Dummy Libraries (for Wayland/EGL/GLESv2)
        id: create_dummy_libs
        run: |
          DUMMY_DIR=./arm64_dummy_libs
          mkdir -p ${DUMMY_DIR}
          
          echo 'Creating dummy libraries: libwayland-client.so, libEGL.so, libGLESv2.so'
          
          create_dummy_lib() {
              local lib_name=$1
              aarch64-linux-gnu-ar qcs ${DUMMY_DIR}/lib${lib_name}.a
              aarch64-linux-gnu-g++ -shared -o ${DUMMY_DIR}/lib${lib_name}.so ${DUMMY_DIR}/lib${lib_name}.a
          }

          create_dummy_lib wayland-client
          create_dummy_lib EGL
          create_dummy_lib GLESv2
          
          echo "DUMMY_DIR=${DUMMY_DIR}" >> $GITHUB_ENV

      - name: Build ARM64 binary
        run: |
          aarch64-linux-gnu-g++ -std=c++17 \
            -I./engine_arm64 \
            -L./engine_arm64 \
            -L${{ env.CROSS_LIB_PATH }} \
            -L${{ env.DUMMY_DIR }} \
            -o ivi_home_screen \
            main.cpp \
            -lflutter_engine \
            -lwayland-client \
            -lEGL \
            -lGLESv2 \
            -lpthread \
            -ldl
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivi_home_screen_arm64
          path: |
            ivi_home_screen
            engine_arm64/libflutter_engine.so
