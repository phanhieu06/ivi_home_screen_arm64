name: Build ARM64 Binary

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install cross-compiler, tools, and headers (AMD64)
        run: |
          # 1. C√†i ƒë·∫∑t c√°c c√¥ng c·ª• ch√©o v√† headers AMD64 (APT ch·ªâ d√πng cho x86_64/AMD64)
          sudo apt-get update -o Acquire::Retries=3 || true 
          sudo apt-get install -y --no-install-recommends \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libwayland-dev libegl1-mesa-dev libgles2-mesa-dev \
            wget dpkg-dev binutils

      - name: Manually Install Core ARM64 Runtime Libraries (Dynamic URL Search - Add SUDO FIX)
        run: |
          # Thi·∫øt l·∫≠p th∆∞ m·ª•c cho th∆∞ vi·ªán ch√©o
          CORE_LIB_DIR=/usr/aarch64-linux-gnu/lib
          # C·∫ßn quy·ªÅn root ƒë·ªÉ t·∫°o th∆∞ m·ª•c h·ªá th·ªëng
          sudo mkdir -p ${CORE_LIB_DIR}
          
          # --- 1. T·∫£i v√† tr√≠ch xu·∫•t libc6 (glibc) s·ª≠ d·ª•ng t√¨m ki·∫øm ƒë·ªông ---
          echo "Searching for the latest libc6:arm64 version..."
          
          # FIX: S·ª≠ d·ª•ng chu·ªói l·ªánh grep/cut ƒë·ªÉ tr√≠ch xu·∫•t T√äN FILE CH√çNH X√ÅC t·ª´ thu·ªôc t√≠nh href, lo·∫°i b·ªè HTML th·ª´a.
          GLIBC_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/ 2>/dev/null | grep 'libc6_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          GLIBC_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/${GLIBC_FILENAME}"
          
          echo "Found libc6:arm64 at URL: ${GLIBC_URL}. Starting download..."
          wget "${GLIBC_URL}" -O libc6.deb
          
          # KI·ªÇM TRA L·ªñI: N·∫øu t·∫£i xu·ªëng th·∫•t b·∫°i, d·ª´ng l·∫°i ngay
          if [ ! -f libc6.deb ]; then
             echo "ERROR: Failed to download libc6 ARM64 version. Filename extracted: ${GLIBC_FILENAME}"
             exit 1
          fi
          
          dpkg-deb -x libc6.deb /tmp/glibc_extract
          # TH√äM SUDO: C·∫ßn quy·ªÅn root ƒë·ªÉ sao ch√©p v√†o th∆∞ m·ª•c h·ªá th·ªëng
          sudo cp /tmp/glibc_extract/usr/lib/aarch64-linux-gnu/libc.so.6 ${CORE_LIB_DIR}/
          sudo cp /tmp/glibc_extract/usr/lib/aarch64-linux-gnu/libm.so.6 ${CORE_LIB_DIR}/
          
          # --- 2. T·∫£i v√† tr√≠ch xu·∫•t libstdc++6 s·ª≠ d·ª•ng t√¨m ki·∫øm ƒë·ªông ---
          echo "Searching for the latest libstdc++6:arm64 version..."
          
          # FIX: S·ª≠ d·ª•ng chu·ªói l·ªánh grep/cut ƒë·ªÉ tr√≠ch xu·∫•t T√äN FILE CH√çNH X√ÅC t·ª´ thu·ªôc t√≠nh href.
          LIBSTDC_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/g/gcc-12/ 2>/dev/null | grep 'libstdc++6_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          LIBSTDC_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/g/gcc-12/${LIBSTDC_FILENAME}"

          echo "Found libstdc++6:arm64 at URL: ${LIBSTDC_URL}. Starting download..."
          wget "${LIBSTDC_URL}" -O libstdc++.deb

          # KI·ªÇM TRA L·ªñI: N·∫øu t·∫£i xu·ªëng th·∫•t b·∫°i, d·ª´ng l·∫°i ngay
          if [ ! -f libstdc++.deb ]; then
             echo "ERROR: Failed to download libstdc++6 ARM64 version. Filename extracted: ${LIBSTDC_FILENAME}"
             exit 1
          fi

          dpkg-deb -x libstdc++.deb /tmp/libstdc_extract
          # TH√äM SUDO: C·∫ßn quy·ªÅn root ƒë·ªÉ sao ch√©p v√†o th∆∞ m·ª•c h·ªá th·ªëng
          sudo cp /tmp/libstdc_extract/usr/lib/aarch64-linux-gnu/libstdc++.so.6 ${CORE_LIB_DIR}/
          
          # --- 3. T·∫£i v√† tr√≠ch xu·∫•t libfontconfig1
          echo "Searching for the latest libfontconfig1:arm64 version..."
          
          # T√¨m ki·∫øm file .deb
          FONTCONFIG_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/f/fontconfig/ 2>/dev/null | grep 'libfontconfig1_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          FONTCONFIG_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/f/fontconfig/${FONTCONFIG_FILENAME}"

          echo "Found libfontconfig1:arm64 at URL: ${FONTCONFIG_URL}. Starting download..."
          wget "${FONTCONFIG_URL}" -O libfontconfig1.deb

          if [ ! -f libfontconfig1.deb ]; then
             echo "ERROR: Failed to download libfontconfig1 ARM64 version. Filename extracted: ${FONTCONFIG_FILENAME}"
             exit 1
          fi

          dpkg-deb -x libfontconfig1.deb /tmp/fontconfig_extract
          # Fontconfig library l√† libfontconfig.so.1
          sudo cp /tmp/fontconfig_extract/usr/lib/aarch64-linux-gnu/libfontconfig.so.1 ${CORE_LIB_DIR}/
          # T·∫†O SYMLINK: T·∫°o libfontconfig.so
          sudo ln -s libfontconfig.so.1 ${CORE_LIB_DIR}/libfontconfig.so
          
          # --- 4. T·∫£i v√† tr√≠ch xu·∫•t libfreetype6 (FreeType)
          echo "Searching for the latest libfreetype6:arm64 version..."
          
          # T√¨m ki·∫øm file .deb
          FREETYPE_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/f/freetype/ 2>/dev/null | grep 'libfreetype6_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          FREETYPE_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/f/freetype/${FREETYPE_FILENAME}"

          echo "Found libfreetype6:arm64 at URL: ${FREETYPE_URL}. Starting download..."
          wget "${FREETYPE_URL}" -O libfreetype6.deb

          if [ ! -f libfreetype6.deb ]; then
             echo "ERROR: Failed to download libfreetype6 ARM64 version. Filename extracted: ${FREETYPE_FILENAME}"
             exit 1
          fi

          dpkg-deb -x libfreetype6.deb /tmp/freetype_extract
          # Th∆∞ vi·ªán th·ª±c t·∫ø l√† libfreetype.so.6
          sudo cp /tmp/freetype_extract/usr/lib/aarch64-linux-gnu/libfreetype.so.6 ${CORE_LIB_DIR}/
          # T·∫†O SYMLINK: T·∫°o libfreetype.so
          sudo ln -s libfreetype.so.6 ${CORE_LIB_DIR}/libfreetype.so

          # --- 5. T·∫£i v√† tr√≠ch xu·∫•t libexpat1 (XML Parser)
          echo "Searching for the latest libexpat1:arm64 version..."
          
          # T√¨m ki·∫øm file .deb
          EXPAT_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/e/expat/ 2>/dev/null | grep 'libexpat1_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          EXPAT_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/e/expat/${EXPAT_FILENAME}"

          echo "Found libexpat1:arm64 at URL: ${EXPAT_URL}. Starting download..."
          wget "${EXPAT_URL}" -O libexpat1.deb

          if [ ! -f libexpat1.deb ]; then
             echo "ERROR: Failed to download libexpat1 ARM64 version. Filename extracted: ${EXPAT_FILENAME}"
             exit 1
          fi

          dpkg-deb -x libexpat1.deb /tmp/expat_extract
          # Th∆∞ vi·ªán th·ª±c t·∫ø l√† libexpat.so.1
          sudo cp /tmp/expat_extract/usr/lib/aarch64-linux-gnu/libexpat.so.1 ${CORE_LIB_DIR}/
          # T·∫†O SYMLINK: T·∫°o libexpat.so
          sudo ln -s libexpat.so.1 ${CORE_LIB_DIR}/libexpat.so
          
          # --- 6. T·∫£i v√† tr√≠ch xu·∫•t zlib (libz.so.1) üëà TH∆Ø VI·ªÜN M·ªöI
          echo "Searching for the latest zlib1g:arm64 version..."
          ZLIB_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/z/zlib/ 2>/dev/null | grep 'zlib1g_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          ZLIB_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/z/zlib/${ZLIB_FILENAME}"
          echo "Found zlib1g:arm64 at URL: ${ZLIB_URL}. Starting download..."
          wget "${ZLIB_URL}" -O zlib1g.deb
          if [ ! -f zlib1g.deb ]; then echo "ERROR: Failed to download zlib1g ARM64 version."; exit 1; fi
          dpkg-deb -x zlib1g.deb /tmp/zlib_extract
          sudo cp /tmp/zlib_extract/usr/lib/aarch64-linux-gnu/libz.so.1 ${CORE_LIB_DIR}/
          sudo ln -s libz.so.1 ${CORE_LIB_DIR}/libz.so
          
          # --- 7. T·∫£i v√† tr√≠ch xu·∫•t libbz2 (libbz2.so.1.0) üëà TH∆Ø VI·ªÜN M·ªöI
          echo "Searching for the latest libbz2-1.0:arm64 version..."
          BZ2_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/b/bzip2/ 2>/dev/null | grep 'libbz2-1.0_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          BZ2_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/b/bzip2/${BZ2_FILENAME}"
          echo "Found libbz2-1.0:arm64 at URL: ${BZ2_URL}. Starting download..."
          wget "${BZ2_URL}" -O libbz2.deb
          if [ ! -f libbz2.deb ]; then echo "ERROR: Failed to download libbz2-1.0 ARM64 version."; exit 1; fi
          dpkg-deb -x libbz2.deb /tmp/bz2_extract
          # Th∆∞ vi·ªán th·ª±c t·∫ø l√† libbz2.so.1.0
          sudo cp /tmp/bz2_extract/usr/lib/aarch64-linux-gnu/libbz2.so.1.0 ${CORE_LIB_DIR}/
          sudo ln -s libbz2.so.1.0 ${CORE_LIB_DIR}/libbz2.so
          
          # --- 8. T·∫£i v√† tr√≠ch xu·∫•t libpng16 (libpng16.so.16) üëà TH∆Ø VI·ªÜN M·ªöI
          echo "Searching for the latest libpng16-16:arm64 version..."
          PNG_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/libp/libpng/ 2>/dev/null | grep 'libpng16-16_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          PNG_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/libp/libpng/${PNG_FILENAME}"
          echo "Found libpng16-16:arm64 at URL: ${PNG_URL}. Starting download..."
          wget "${PNG_URL}" -O libpng.deb
          if [ ! -f libpng.deb ]; then echo "ERROR: Failed to download libpng16-16 ARM64 version."; exit 1; fi
          dpkg-deb -x libpng.deb /tmp/png_extract
          # Th∆∞ vi·ªán th·ª±c t·∫ø l√† libpng16.so.16
          sudo cp /tmp/png_extract/usr/lib/aarch64-linux-gnu/libpng16.so.16 ${CORE_LIB_DIR}/
          sudo ln -s libpng16.so.16 ${CORE_LIB_DIR}/libpng16.so
          
          # --- 9. T·∫£i v√† tr√≠ch xu·∫•t libbrotlidec1 (libbrotlidec.so.1) üëà TH∆Ø VI·ªÜN M·ªöI
          echo "Searching for the latest libbrotlidec1:arm64 version..."
          BROTLI_FILENAME=$(wget -O - http://ports.ubuntu.com/ubuntu-ports/pool/main/b/brotli/ 2>/dev/null | grep 'libbrotlidec1_.*_arm64.deb' | tail -n 1 | grep -o 'href="[^"]*"' | head -1 | cut -d\" -f2)
          BROTLI_URL="http://ports.ubuntu.com/ubuntu-ports/pool/main/b/brotli/${BROTLI_FILENAME}"
          echo "Found libbrotlidec1:arm64 at URL: ${BROTLI_URL}. Starting download..."
          wget "${BROTLI_URL}" -O libbrotli.deb
          if [ ! -f libbrotli.deb ]; then echo "ERROR: Failed to download libbrotlidec1 ARM64 version."; exit 1; fi
          dpkg-deb -x libbrotli.deb /tmp/brotli_extract
          # Th∆∞ vi·ªán th·ª±c t·∫ø l√† libbrotlidec.so.1
          sudo cp /tmp/brotli_extract/usr/lib/aarch64-linux-gnu/libbrotlidec.so.1 ${CORE_LIB_DIR}/
          sudo ln -s libbrotlidec.so.1 ${CORE_LIB_DIR}/libbrotlidec.so


          # ƒê·∫∑t bi·∫øn m√¥i tr∆∞·ªùng cho b∆∞·ªõc build
          echo "CROSS_LIB_PATH=${CORE_LIB_DIR}" >> $GITHUB_ENV
          
      - name: Create ARM64 Dummy Libraries (for Wayland/EGL/GLESv2)
        id: create_dummy_libs
        run: |
          DUMMY_DIR=./arm64_dummy_libs
          mkdir -p ${DUMMY_DIR}
          
          echo 'Creating dummy libraries: libwayland-client.so, libEGL.so, libGLESv2.so'
          
          create_dummy_lib() {
              local lib_name=$1
              aarch64-linux-gnu-ar qcs ${DUMMY_DIR}/lib${lib_name}.a
              aarch64-linux-gnu-g++ -shared -o ${DUMMY_DIR}/lib${lib_name}.so ${DUMMY_DIR}/lib${lib_name}.a
          }

          create_dummy_lib wayland-client
          create_dummy_lib EGL
          create_dummy_lib GLESv2
          
          echo "DUMMY_DIR=${DUMMY_DIR}" >> $GITHUB_ENV

      - name: Build ARM64 binary
        run: |
          # Th√™m c·ªù linker ƒë·∫∑c bi·ªát ƒë·ªÉ b·ªè qua c√°c l·ªói GLIBC n·ªôi b·ªô
          aarch64-linux-gnu-g++ -std=c++17 \
            -Wl,--unresolved-symbols=ignore-in-shared-libs \
            -I./engine_arm64 \
            -L./engine_arm64 \
            -L${{ env.CROSS_LIB_PATH }} \
            -L${{ env.DUMMY_DIR }} \
            -o ivi_home_screen \
            main.cpp \
            -lflutter_engine \
            -lwayland-client \
            -lEGL \
            -lGLESv2 \
            -lfontconfig \
            -lfreetype \
            -lexpat \
            -lz \
            -lbz2 \
            -lpng16 \
            -lbrotlidec \
            -lpthread \
            -ldl
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ivi_home_screen_arm64
          path: |
            ivi_home_screen
            engine_arm64/libflutter_engine.so
