# Thiáº¿t láº­p thÆ° má»¥c cho thÆ° viá»‡n chÃ©o
CORE_LIB_DIR=/usr/aarch64-linux-gnu/lib

# Cáº§n quyá»n root Ä‘á»ƒ táº¡o thÆ° má»¥c há»‡ thá»‘ng
# LÆ°u Ã½: Lá»‡nh nÃ y cÃ³ thá»ƒ khÃ´ng cáº§n thiáº¿t náº¿u thÆ° má»¥c Ä‘Ã£ tá»“n táº¡i trong mÃ´i trÆ°á»ng GitHub Actions, 
# nhÆ°ng viá»‡c cÃ³ nÃ³ sáº½ Ä‘áº£m báº£o script hoáº¡t Ä‘á»™ng.
sudo mkdir -p ${CORE_LIB_DIR}

# HÃ m tÃ¬m kiáº¿m vÃ  táº£i xuá»‘ng thÆ° viá»‡n
# Tham sá»‘ 1: TÃªn thÆ° viá»‡n cáº§n tÃ¬m (vÃ­ dá»¥: 'libc6_.*_arm64.deb')
# Tham sá»‘ 2: URL thÆ° má»¥c cÆ¡ sá»Ÿ (vÃ­ dá»¥: 'http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/')
# Tham sá»‘ 3: TÃªn file Ä‘áº§u ra (vÃ­ dá»¥: 'libc6.deb')
# Tham sá»‘ 4: ÄÆ°á»ng dáº«n thÆ° viá»‡n thá»±c táº¿ bÃªn trong gÃ³i DEB (vÃ­ dá»¥: '/usr/lib/aarch64-linux-gnu/libc.so.6')
# Tham sá»‘ 5 (TÃ¹y chá»n): TÃªn symlink (vÃ­ dá»¥: 'libc.so')
download_and_extract() {
    local SEARCH_PATTERN=$1
    local BASE_URL=$2
    local OUTPUT_FILENAME=$3
    local LIB_PATH_IN_DEB=$4
    local SYMLINK_NAME=$5
    
    echo "Searching for the latest ${SEARCH_PATTERN} version..."

    # CÃCH FIX Má»šI: Sá»­ dá»¥ng grep -o Ä‘á»ƒ trá»±c tiáº¿p tÃ¬m kiáº¿m thuá»™c tÃ­nh href chá»©a tÃªn file,
    # sau Ä‘Ã³ dÃ¹ng cut Ä‘á»ƒ trÃ­ch xuáº¥t tÃªn file chÃ­nh xÃ¡c.
    FILENAME=$(wget -O - ${BASE_URL} 2>/dev/null | grep -o 'href="'${SEARCH_PATTERN}'"' | tail -n 1 | cut -d\" -f2)
    
    # Kiá»ƒm tra náº¿u khÃ´ng tÃ¬m tháº¥y tÃªn file (lá»—i cá»§a báº¡n xáº£y ra á»Ÿ Ä‘Ã¢y)
    if [ -z "${FILENAME}" ]; then
       echo "ERROR: Failed to find filename matching pattern: ${SEARCH_PATTERN} from ${BASE_URL}"
       exit 1
    fi
    
    URL="${BASE_URL}${FILENAME}"
    echo "Found at URL: ${URL}. Starting download..."
    wget "${URL}" -O ${OUTPUT_FILENAME}
    
    if [ ! -f ${OUTPUT_FILENAME} ]; then
       echo "ERROR: Failed to download ${OUTPUT_FILENAME}."
       exit 1
    fi
    
    EXTRACT_DIR="/tmp/${OUTPUT_FILENAME}_extract"
    dpkg-deb -x ${OUTPUT_FILENAME} ${EXTRACT_DIR}
    
    # Sao chÃ©p thÆ° viá»‡n
    LIB_ACTUAL_PATH="${LIB_PATH_IN_DEB}"
    LIB_ACTUAL_NAME=$(basename "${LIB_ACTUAL_PATH}")
    
    # THÃŠM SUDO: Cáº§n quyá»n root Ä‘á»ƒ sao chÃ©p vÃ o thÆ° má»¥c há»‡ thá»‘ng
    sudo cp ${EXTRACT_DIR}${LIB_ACTUAL_PATH} ${CORE_LIB_DIR}/

    # Táº¡o symlink náº¿u Ä‘Æ°á»£c cung cáº¥p
    if [ ! -z "${SYMLINK_NAME}" ]; then
      sudo ln -s ${LIB_ACTUAL_NAME} ${CORE_LIB_DIR}/${SYMLINK_NAME}
    fi
    echo "Successfully installed ${LIB_ACTUAL_NAME}."
}

# --- 1. Táº£i vÃ  trÃ­ch xuáº¥t libc6 (glibc) ---
download_and_extract \
  'libc6_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/g/glibc/' \
  'libc6.deb' \
  '/usr/lib/aarch64-linux-gnu/libc.so.6' \
  'libc.so'

# libm.so.6 cáº§n Ä‘Æ°á»£c cÃ i Ä‘áº·t riÃªng vÃ¬ nÃ³ Ä‘Æ°á»£c bao gá»“m trong libc6.deb
sudo cp /tmp/libc6.deb_extract/usr/lib/aarch64-linux-gnu/libm.so.6 ${CORE_LIB_DIR}/
sudo ln -s libm.so.6 ${CORE_LIB_DIR}/libm.so
echo "Successfully installed libm.so.6."

# --- 2. Táº£i vÃ  trÃ­ch xuáº¥t libstdc++6 ---
download_and_extract \
  'libstdc++6_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/g/gcc-12/' \
  'libstdc++.deb' \
  '/usr/lib/aarch64-linux-gnu/libstdc++.so.6' \
  'libstdc++.so'

# --- 3. Táº£i vÃ  trÃ­ch xuáº¥t libfontconfig1 ---
download_and_extract \
  'libfontconfig1_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/f/fontconfig/' \
  'libfontconfig1.deb' \
  '/usr/lib/aarch64-linux-gnu/libfontconfig.so.1' \
  'libfontconfig.so'

# --- 4. Táº£i vÃ  trÃ­ch xuáº¥t libfreetype6 (FreeType) ---
download_and_extract \
  'libfreetype6_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/f/freetype/' \
  'libfreetype6.deb' \
  '/usr/lib/aarch64-linux-gnu/libfreetype.so.6' \
  'libfreetype.so'

# --- 5. Táº£i vÃ  trÃ­ch xuáº¥t libexpat1 (XML Parser) ---
download_and_extract \
  'libexpat1_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/e/expat/' \
  'libexpat1.deb' \
  '/usr/lib/aarch64-linux-gnu/libexpat.so.1' \
  'libexpat.so'

# --- 6. Táº£i vÃ  trÃ­ch xuáº¥t zlib (libz.so.1) ---
download_and_extract \
  'zlib1g_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/z/zlib/' \
  'zlib1g.deb' \
  '/usr/lib/aarch64-linux-gnu/libz.so.1' \
  'libz.so'

# --- 7. Táº£i vÃ  trÃ­ch xuáº¥t libbz2 (libbz2.so.1.0) ---
download_and_extract \
  'libbz2-1.0_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/b/bzip2/' \
  'libbz2.deb' \
  '/usr/lib/aarch64-linux-gnu/libbz2.so.1.0' \
  'libbz2.so'

# --- 8. Táº£i vÃ  trÃ­ch xuáº¥t libpng16 (libpng16.so.16) ðŸ‘ˆ Sá»¬A Lá»–I á»ž ÄÃ‚Y
download_and_extract \
  'libpng16-16_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/libp/libpng/' \
  'libpng.deb' \
  '/usr/lib/aarch64-linux-gnu/libpng16.so.16' \
  'libpng.so'

# --- 9. Táº£i vÃ  trÃ­ch xuáº¥t libbrotlidec1 (libbrotlidec.so.1) ---
download_and_extract \
  'libbrotlidec1_.*_arm64.deb' \
  'http://ports.ubuntu.com/ubuntu-ports/pool/main/b/brotli/' \
  'libbrotli.deb' \
  '/usr/lib/aarch64-linux-gnu/libbrotlidec.so.1' \
  'libbrotlidec.so'
  
# Äáº·t biáº¿n mÃ´i trÆ°á»ng cho bÆ°á»›c build
echo "CROSS_LIB_PATH=${CORE_LIB_DIR}" >> $GITHUB_ENV
